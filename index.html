<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTM Quote Assist Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        .checkbox-card {
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow-lg */
            transition: all 0.3s ease-in-out;
        }
        .checkbox-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); /* shadow-xl */
        }
        /* General checkbox styles */
        .checkbox-input {
            appearance: none;
            background-color: #fff;
            margin-right: 0.5rem;
            width: 1.25em;
            height: 1.25em;
            border: 2px solid #D1D5DB; /* Default border: Tailwind gray-300 */
            border-radius: 0.25em;
            transform: translateY(-0.075em);
            display: inline-grid;
            place-content: center;
            cursor: pointer;
            transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out;
        }
        .checkbox-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 2px #60a5fa; /* Default focus: Tailwind blue-400 */
        }
        .checkbox-input::before {
            content: "";
            width: 0.75em;
            height: 0.75em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #2563eb; /* Default checkmark color container (blue) */
            background-color: CanvasText; 
            transform-origin: bottom left;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .checkbox-input:checked {
            border-color: #2563eb; /* Default checked border: Tailwind blue-600 */
            background-color: #2563eb; /* Default checked background: Tailwind blue-600 */
        }
        .checkbox-input:checked::before {
            transform: scale(1);
            box-shadow: inset 1em 1em #fff; /* White checkmark */
        }

        /* General label styles */
        .checkbox-label {
            cursor: pointer;
            color: #374151; /* Default label color: Tailwind gray-700 */
            transition: color 0.2s ease-in-out;
            user-select: none;
        }
        .checkbox-input:checked + .checkbox-label {
            color: #1d4ed8; /* Default checked label color: Tailwind blue-700 */
            font-weight: 500;
        }
        .checkbox-input:disabled + .checkbox-label {
            color: #9ca3af; /* Tailwind gray-400 */
            cursor: not-allowed;
        }
         .checkbox-input:disabled {
            background-color: #f3f4f6; /* Tailwind gray-100 */
            border-color: #e5e7eb; /* Tailwind gray-200 */
            cursor: not-allowed;
        }

        /* Specific styles for "Is emergency?" checkbox and label */
        .emergency-checkbox {
            border-color: #c32033; 
        }
        .emergency-checkbox:checked {
            background-color: #c32033; 
            border-color: #c32033; 
        }
        .emergency-checkbox:checked::before {
            box-shadow: inset 1em 1em #fff; 
        }
         .emergency-checkbox:focus { 
            box-shadow: 0 0 0 2px #fca5a5; 
        }
        .emergency-label {
            color: #c32033 !important; 
            text-transform: uppercase;
            font-weight: 600; 
        }
        .emergency-checkbox:checked + .emergency-label {
             color: #c32033 !important;
             font-weight: 600;
        }

        /* Action Icon Styles */
        .action-icon-container {
            display: flex;
            justify-content: space-around; 
            align-items: flex-start; 
            padding: 1rem 0;
            margin-bottom: 1rem; 
            border-bottom: 1px solid #e5e7eb; 
        }
        .action-icon {
            text-align: center;
            transition: opacity 0.3s ease-in-out;
            flex: 1; 
            max-width: 100px; 
        }
        .action-icon img {
            width: 30px;
            height: 30px;
            margin: 0 auto 0.25rem auto; 
        }
        .action-icon p {
            font-size: 0.75rem; 
            font-weight: 500; 
            color: #4b5563; 
        }
        .action-icon.inactive {
            opacity: 0.25;
        }
        .action-icon.active {
            opacity: 1;
        }


        /* Table styling */
        .output-table th, .output-table td {
            padding: 0.75rem 1rem; 
            text-align: left;
            font-size: 0.875rem; 
        }
        .output-table th {
            background-color: #e5e7eb; 
            color: #374151; 
            font-weight: 600; 
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .output-table td {
            color: #1f2937; 
            border-bottom: 1px solid #e5e7eb; 
        }
        .output-table tr:last-child td {
            border-bottom: none;
        }
        .scrollable-checkbox-group {
            max-height: 200px; 
            overflow-y: auto;
            padding-right: 0.5rem; 
        }
        .additional-req-group { 
             max-height: 250px; 
            overflow-y: auto;
            padding-right: 0.5rem; 
        }
         .contract-type-group { 
             max-height: 250px; 
            overflow-y: auto;
            padding-right: 0.5rem; 
        }
        .notes-section ul {
            list-style-type: disc;
            padding-left: 1.5rem; 
            margin-top: 0.5rem;
        }
        .notes-section li {
            color: #4b5563; 
            font-size: 0.875rem; 
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 sm:p-6">

    <div class="w-full max-w-6xl bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
        <header class="mb-8 text-center"> 
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">RTM Quote Assist Tool</h1>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="checkbox-card">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Contract Type</h2>
                <div class="space-y-3 contract-type-group"> 
                    <div>
                        <input type="checkbox" id="osa" name="contractType" value="OSA" class="checkbox-input">
                        <label for="osa" class="checkbox-label">OSA LOT 2.0</label>
                    </div>
                    <div>
                        <input type="checkbox" id="onsa" name="contractType" value="ONSA" class="checkbox-input">
                        <label for="onsa" class="checkbox-label">ONSA</label>
                    </div>
                    <div>
                        <input type="checkbox" id="fibre" name="contractType" value="Fibre Build" class="checkbox-input">
                        <label for="fibre" class="checkbox-label">Fibre Build</label>
                    </div>
                    <hr class="my-3 border-gray-300"> 
                    <div>
                        <input type="checkbox" id="moreThan12Hours" name="duration" value="More than 12 hours" class="checkbox-input">
                        <label for="moreThan12Hours" class="checkbox-label">Is more than 1 day?</label>
                    </div>
                    <div>
                        <input type="checkbox" id="emergency" name="urgency" value="Emergency" class="checkbox-input emergency-checkbox">
                        <label for="emergency" class="checkbox-label emergency-label">IS EMERGENCY?</label>
                    </div>
                </div>
            </div>

            <div class="checkbox-card">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Traffic Management</h2>
                <div class="space-y-3 scrollable-checkbox-group">
                    <div><input type="checkbox" id="tmTwoWayLightsUpTo" name="trafficManagement" value="2 Way Lights (Up to 40mph)" class="checkbox-input"><label for="tmTwoWayLightsUpTo" class="checkbox-label">2 Way Lights (Up to 40mph)</label></div>
                    <div><input type="checkbox" id="tmTwoWayLightsOver" name="trafficManagement" value="2 Way Lights (Over 40mph)" class="checkbox-input"><label for="tmTwoWayLightsOver" class="checkbox-label">2 Way Lights (Over 40mph)</label></div>
                    <div><input type="checkbox" id="tmThreeWayLights" name="trafficManagement" value="3 Way Lights" class="checkbox-input"><label for="tmThreeWayLights" class="checkbox-label">3 Way Lights</label></div>
                    <div><input type="checkbox" id="tmFourWayLights" name="trafficManagement" value="4 Way Lights" class="checkbox-input"><label for="tmFourWayLights" class="checkbox-label">4 Way Lights</label></div>
                    <div><input type="checkbox" id="tmFiveWayLights" name="trafficManagement" value="5 Way Lights" class="checkbox-input"><label for="tmFiveWayLights" class="checkbox-label">5 Way Lights</label></div>
                    <div><input type="checkbox" id="tmBusStopSuspension" name="trafficManagement" value="Bus Stop Suspension" class="checkbox-input"><label for="tmBusStopSuspension" class="checkbox-label">Bus Stop Suspension</label></div>
                    <div><input type="checkbox" id="tmFootpathClosure" name="trafficManagement" value="Footpath Closure" class="checkbox-input"><label for="tmFootpathClosure" class="checkbox-label">Footpath Closure</label></div>
                    <div><input type="checkbox" id="tmLaneClosureUpTo" name="trafficManagement" value="Lane Closure (Up to 40mph)" class="checkbox-input"><label for="tmLaneClosureUpTo" class="checkbox-label">Lane Closure (Up to 40mph)</label></div>
                    <div><input type="checkbox" id="tmLaneClosureOver" name="trafficManagement" value="Lane Closure (Over 40mph)" class="checkbox-input"><label for="tmLaneClosureOver" class="checkbox-label">Lane Closure (Over 40mph)</label></div>
                    <div><input type="checkbox" id="tmPedCrossingOnly" name="trafficManagement" value="Ped Crossing Only" class="checkbox-input"><label for="tmPedCrossingOnly" class="checkbox-label">Ped Crossing Only</label></div>
                    <div><input type="checkbox" id="tmPreCone" name="trafficManagement" value="Pre Cone" class="checkbox-input"><label for="tmPreCone" class="checkbox-label">Pre Cone</label></div>
                    
                    <div><input type="checkbox" id="tmRoadClosure25" name="trafficManagement" value="Road Closure Up to 25 Signs" class="checkbox-input"><label for="tmRoadClosure25" class="checkbox-label">Road Closure Up to 25 Signs</label></div>
                    <div><input type="checkbox" id="tmRoadClosure60" name="trafficManagement" value="Road Closure Up to 60 signs" class="checkbox-input"><label for="tmRoadClosure60" class="checkbox-label">Road Closure Up to 60 signs</label></div>
                    <div><input type="checkbox" id="tmRoadClosure85" name="trafficManagement" value="Road Closure Up to 85 signs" class="checkbox-input"><label for="tmRoadClosure85" class="checkbox-label">Road Closure Up to 85 signs</label></div>
                    
                    <div><input type="checkbox" id="tmRoadClosureNTR" name="trafficManagement" value="Road Closure NTR" class="checkbox-input"><label for="tmRoadClosureNTR" class="checkbox-label">Road Closure NTR</label></div>
                    <div><input type="checkbox" id="tmStopGo2Way" name="trafficManagement" value="Stop and Go 2 Way" class="checkbox-input"><label for="tmStopGo2Way" class="checkbox-label">Stop and Go 2 Way</label></div>
                    <div><input type="checkbox" id="tmStopGo3Way" name="trafficManagement" value="Stop and Go 3 Way" class="checkbox-input"><label for="tmStopGo3Way" class="checkbox-label">Stop and Go 3 Way</label></div>
                    <div><input type="checkbox" id="tmStopGo4Way" name="trafficManagement" value="Stop and Go 4 Way" class="checkbox-input"><label for="tmStopGo4Way" class="checkbox-label">Stop and Go 4 Way</label></div>
                    <div><input type="checkbox" id="tmPlanOnly" name="trafficManagement" value="TM Plan only" class="checkbox-input"><label for="tmPlanOnly" class="checkbox-label">TM Plan only</label></div>
                    <div><input type="checkbox" id="tmTO15" name="trafficManagement" value="TO15" class="checkbox-input"><label for="tmTO15" class="checkbox-label">TO15</label></div>
                    <div><input type="checkbox" id="tmTO15NTR" name="trafficManagement" value="TO15 NTR" class="checkbox-input"><label for="tmTO15NTR" class="checkbox-label">TO15 NTR</label></div>
                </div>
            </div>

            <div class="checkbox-card">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Additional Requirements</h2>
                <div class="space-y-3 additional-req-group">
                    <div>
                        <input type="checkbox" id="manualControl" name="additional" value="Manual Control" class="checkbox-input">
                        <label for="manualControl" class="checkbox-label">Manual Control</label>
                    </div>
                    <div>
                        <input type="checkbox" id="ooh" name="additional" value="OOH" class="checkbox-input">
                        <label for="ooh" class="checkbox-label">OOH</label>
                    </div>
                    <div>
                        <input type="checkbox" id="pedSets" name="additional" value="Ped Sets" class="checkbox-input">
                        <label for="pedSets" class="checkbox-label">Ped Sets</label>
                    </div>
                     <div>
                        <input type="checkbox" id="additionalTmPlan" name="additional" value="Additional TM Plan" class="checkbox-input">
                        <label for="additionalTmPlan" class="checkbox-label">Additional TM Plan</label>
                    </div>
                     <div>
                        <input type="checkbox" id="specialSigns" name="additional" value="Special Signs" class="checkbox-input">
                        <label for="specialSigns" class="checkbox-label">Special Signs</label>
                    </div>
                     <div>
                        <input type="checkbox" id="bss" name="additional" value="Bus Stop Suspension" class="checkbox-input">
                        <label for="bss" class="checkbox-label">Bus Stop Suspension</label>
                    </div>
                </div>
            </div>
        </div>

        <div id="outputContainer" class="bg-blue-50 p-6 rounded-lg shadow-inner">
            <p id="outputMessage" class="text-sm text-gray-600 text-center mb-4">Please make a selection from Contract Type and Traffic Management categories.</p>
            <div id="actionIconsPlaceholder" class="action-icon-container">
                 <div id="invoiceActionIcon" class="action-icon inactive">
                    <img src="https://www.svgrepo.com/show/6974/one.svg" alt="Invoice Icon">
                    <p>Invoice</p>
                </div>
                <div id="afpActionIcon" class="action-icon inactive">
                    <img src="https://www.svgrepo.com/show/12680/two.svg" alt="AFP Icon">
                    <p>AFP</p>
                </div>
                <div id="iaInvoiceActionIcon" class="action-icon inactive">
                    <img src="https://www.svgrepo.com/show/7916/three.svg" alt="I&A Invoice Icon"> 
                    <p>I&A Invoice</p>
                </div>
                <div id="requestSlipActionIcon" class="action-icon inactive">
                    <img src="https://www.svgrepo.com/show/41065/four.svg" alt="Request SLIP Icon"> 
                    <p>Request SLIP</p>
                </div>
            </div>
            <div id="invoiceTableContainer" class="mb-6"></div>
            <div id="afpTableContainer" class="mb-6"></div>
            <div id="additionalNotesContainer" class="notes-section"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const contractTypeCheckboxes = document.querySelectorAll('input[name="contractType"]');
            const trafficManagementCheckboxes = document.querySelectorAll('input[name="trafficManagement"]');
            
            const manualControlCheckbox = document.getElementById('manualControl');
            const oohCheckbox = document.getElementById('ooh');
            const pedSetsCheckbox = document.getElementById('pedSets'); 
            const additionalTmPlanCheckbox = document.getElementById('additionalTmPlan');
            const specialSignsCheckbox = document.getElementById('specialSigns');
            const bssCheckbox = document.getElementById('bss'); 
            
            const moreThan12HoursCheckbox = document.getElementById('moreThan12Hours');
            const emergencyCheckbox = document.getElementById('emergency');
            
            const outputMessageElement = document.getElementById('outputMessage');
            const invoiceTableContainer = document.getElementById('invoiceTableContainer');
            const afpTableContainer = document.getElementById('afpTableContainer');
            const additionalNotesContainer = document.getElementById('additionalNotesContainer');

            const invoiceActionIcon = document.getElementById('invoiceActionIcon');
            const afpActionIcon = document.getElementById('afpActionIcon');
            const iaInvoiceActionIcon = document.getElementById('iaInvoiceActionIcon');
            const requestSlipActionIcon = document.getElementById('requestSlipActionIcon'); 
            const actionIconsPlaceholder = document.getElementById('actionIconsPlaceholder');


            const quoteItemsData = {
                // OSA LOT 2.0 Traffic Management Items
                TM03_UPTO_TBA: { code: "TBA", description: "TBA", price: 0, onInvoice: true, onAfp: false, has12hrVariant: "TM3A_UPTO_TBA", specialAction: "I&A Invoice" },
                TM3A_UPTO_TBA: { code: "TBA", description: "TBA", price: 0, onInvoice: true, onAfp: false },
                TM03_OVER: { code: "TM03", description: "Traffic control (two-way signals) road speed above 40mph", price: 400, onInvoice: true, onAfp: true, has12hrVariant: "TM3A_OVER" }, 
                TM3A_OVER: { code: "TM3A", description: "Traffic control (two-way signals) road speed above 40mph additional 12 Hours", price: 30, onInvoice: true, onAfp: true }, 
                
                TM04: { code: "TM04", description: "Traffic control (three-way signals)", price: 440, onInvoice: true, onAfp: true, has12hrVariant: "TM4A" },
                TM4A: { code: "TM4A", description: "Traffic control (three-way signals) additional 12 hours", price: 40, onInvoice: true, onAfp: true },
                TM05: { code: "TM05", description: "Traffic control (four way signals or above)", price: 470, onInvoice: true, onAfp: true, has12hrVariant: "TM5A" },
                TM5A: { code: "TM5A", description: "Traffic control (four way signals or above) additional 12 hours", price: 50, onInvoice: true, onAfp: true },
                
                BUS_SUS: { code: "TBA", description: "Bus Stop Suspension (TM Type) - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true, has12hrVariant: "BUS_SUS_12HR" }, 
                BUS_SUS_12HR: { code: "TBA", description: "Bus Stop Suspension (TM Type) additional 12 hours - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true },
                FOOT_CLOS: { code: "TBA", description: "Footpath Closure (TM Type) - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true, has12hrVariant: "FOOT_CLOS_12HR" }, 
                FOOT_CLOS_12HR: { code: "TBA", description: "Footpath Closure (TM Type) additional 12 hours - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true },
                
                TM08_UPTO: { code: "TBA", description: "TBA", price: 0, onInvoice: true, onAfp: false, has12hrVariant: "TM8A_UPTO", specialAction: "I&A Invoice" }, 
                TM8A_UPTO: { code: "TBA", description: "TBA", price: 0, onInvoice: true, onAfp: false },
                TM08_OVER: { code: "TM08", description: "Lane closure (Dual Carriageway or Motorway Over 40mph)", price: 845, onInvoice: true, onAfp: true, has12hrVariant: "TM8A_OVER" },  
                TM8A_OVER: { code: "TM8A", description: "Lane closure (Dual Carriageway or Motorway Over 40mph) additional 12 hours", price: 845, onInvoice: true, onAfp: true }, 
                
                TM10_PC: { code: "TM10", description: "Temporary signalised pedestrian crossing initial 12 hours synthetic (Ped Crossing Only TM)", price: 225, onInvoice: true, onAfp: true, has12hrVariant: "TMA0_PC" }, 
                TMA0_PC: { code: "TMA0", description: "Temporary signalised pedestrian additional 12 hours (Ped Crossing Only TM)", price: 25, onInvoice: true, onAfp: true },
                
                PRE_CONE: { code: "TBA", description: "Pre Cone (TM Type) - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true, has12hrVariant: "PRE_CONE_12HR", specialAction: "I&A Invoice" },
                PRE_CONE_12HR: { code: "TBA", description: "Pre Cone (TM Type) additional 12 hours - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true },
                
                TM09: { code: "TM09", description: "Road Closure (With Diversion Route)", price: 650, onInvoice: true, onAfp: false, has12hrVariant: "TM9A" }, 
                TM9A: { code: "TM9A", description: "Road Closure (With Diversion Route) additional 12 hours", price: 30, onInvoice: true, onAfp: false },
                TM22_RC_NTR: { code: "TM22", description: "Road Closure NTR", price: 495, onInvoice: true, onAfp: true, has12hrVariant: "TM22_RC_NTR_12HR" },
                TM22_RC_NTR_12HR: { code: "TBA", description: "Road Closure NTR additional 12 hours - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true },
                
                TM19: { code: "TM19", description: "Stop & Go 2 Operative Manual Control", price: 495, onInvoice: true, onAfp: true, has12hrVariant: "TM19_12HR" },
                TM19_12HR: { code: "TBA", description: "Stop & Go 2 Operative Manual Control additional 12 hours - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true },
                TM20: { code: "TM20", description: "Stop & Go 3 Operative Manual Control", price: 585, onInvoice: true, onAfp: true, has12hrVariant: "TM20_12HR" },
                TM20_12HR: { code: "TBA", description: "Stop & Go 3 Operative Manual Control additional 12 hours - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true },
                TM21: { code: "TM21", description: "Stop & Go 4 Operative Manual Control", price: 675, onInvoice: true, onAfp: true, has12hrVariant: "TM21_12HR" },
                TM21_12HR: { code: "TBA", description: "Stop & Go 4 Operative Manual Control additional 12 hours - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true },
                
                TM16_PLAN: { code: "TM16", description: "CAD Drawing - Over 40mph inc Multiway Lights (TM Plan only)", price: 70.20, onInvoice: true, onAfp: true }, 
                TM13: { code: "TM13", description: "Temporary carriageway closure TO15", price: 690, onInvoice: true, onAfp: false }, 
                TM22_TO15_NTR: { code: "TM22", description: "TO15 NTR", price: 495, onInvoice: true, onAfp: true },
                TM11: { code: "TM11", description: "Labour only for Manual control of signalised Traffic Management", price: 23.50, onInvoice: true, onAfp: true },
                TM14: { code: "TM14", description: "Out of Hours attendance for Traffic Management", price: 27.50, onInvoice: true, onAfp: false }, 
                TM10_PedSet: { code: "TM10", description: "Temporary signalised pedestrian crossing initial 12 hours synthetic (Ped Sets)", price: 225, onInvoice: true, onAfp: true, has12hrVariant: "TMA0_PedSet" },
                TMA0_PedSet: { code: "TMA0", description: "Temporary signalised pedestrian additional 12 hours (Ped Sets)", price: 25, onInvoice: true, onAfp: true },
                TM16_ADD: { code: "TM16", description: "Additional TM Plan (CAD Drawing - Over 40mph inc Multiway Lights)", price: 70.20, onInvoice: true, onAfp: true },
                SPEC_SIGNS: { code: "TBA", description: "Special Signs - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true }, 
                BSS_ADD: { code: "TBA", description: "Bus Stop Suspension (Additional Requirement) - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true }, 
                TM15: { code: "TM15", description: "Emergency Call Out Fee", price: 90, onInvoice: true, onAfp: true }, // OSA Emergency Fee

                ONSA_2_WAY_OVER_40: {
                    onInvoice: true, onAfp: true, 
                    standardItems: [
                        { code: "MTS11.1", description: "2 Way TM, Delivery, Setup & Hire, In Hours (First Day) - Above 40MPH to 60MPH", price: 230 },
                        { code: "MTS11.2", description: "2 Way TM Dismantle, Collection, In Hours (First Day) - Above 40MPH to 60MPH", price: 160 }
                    ],
                    oohItems: [
                        { code: "MTS11.4", description: "2 Way TM, Delivery, Setup & Hire, Out of Hours (First Day) - Above 40MPH to 60MPH", price: 285 },
                        { code: "MTS11.5", description: "2 Way TM Dismantle, Collection, Out of Hours (First Day) - Above 40MPH to 60MPH", price: 195 } 
                    ],
                    secondDayItems: [
                        { code: "MTS11.3", description: "2 Way TM Daily Hire Second Day Onwards - Above 40MPH to 60MPH", price: 30 }
                    ]
                },
                ONSA_3_WAY: {
                    onInvoice: true, onAfp: true,
                    standardItems: [
                        { code: "MTS12", description: "3 Way TM, Delivery, Setup & Hire, In Hours (First Day)", price: 230 },
                        { code: "MTS13", description: "3 Way TM Dismantle, Collection, In Hours (First Day)", price: 145 },
                        { code: "MTS76", description: "TM Drawings & Planning", price: 75} 
                    ],
                    oohItems: [
                        { code: "MTS15", description: "3 Way TM, Delivery, Setup & Hire, Out of Hours (First Day)", price: 310 },
                        { code: "MTS16", description: "3 Way TM Dismantle, Collection, Out of Hours (First Day)", price: 205 },
                        { code: "MTS76", description: "TM Drawings & Planning", price: 75}
                    ],
                    secondDayItems: [
                        { code: "MTS14", description: "3 Way TM Daily Hire Second Day Onwards", price: 35 }
                    ]
                },
                ONSA_4_WAY: {
                    onInvoice: true, onAfp: true,
                    standardItems: [
                        { code: "MTS17", description: "4 Way TM, Delivery, Setup & Hire, In Hours (First Day)", price: 255 },
                        { code: "MTS18", description: "4 Way TM Dismantle, Collection, In Hours (First Day)", price: 145 },
                        { code: "MTS76", description: "TM Drawings & Planning", price: 75}
                    ],
                    oohItems: [
                        { code: "MTS20", description: "4 Way TM, Delivery, Setup & Hire, Out of Hours (First Day)", price: 335 },
                        { code: "MTS21", description: "4 Way TM Dismantle, Collection, Out of Hours (First Day)", price: 220 },
                        { code: "MTS76", description: "TM Drawings & Planning", price: 75}
                    ],
                    secondDayItems: [
                        { code: "MTS19", description: "4 Way TM Daily Hire Second Day Onwards", price: 45 }
                    ]
                },
                ONSA_FOOTPATH_CLOSURE: {
                    onInvoice: true, onAfp: true,
                    standardItems: [
                        { code: "MTS41", description: "Footpath Closure & Diversion Up to 60 Signs, Delivery, Collection, Setup & Hire, In Hours (Weekly)", price: 325 }
                    ],
                    oohItems: [
                        { code: "MTS42", description: "Footpath Closure & Diversion Up to 60 Signs, Delivery, Collection, Setup & Hire, Out Of Hours", price: 375 }
                    ]
                },
                 ONSA_LANE_CLOSURE_OVER_40: { 
                    onInvoice: true, onAfp: true,
                    standardItems: [
                        { code: "MTS43", description: "Dual Carriageway Closure, 50 mph or above Delivery, Collection, Setup & Hire, In Hours", price: 1375 },
                        { code: "MTS76", description: "TM Drawings & Planning", price: 75 }
                    ],
                    oohItems: [
                        { code: "MTS44", description: "Dual Carriageway Closure, 50 mph or above Delivery, Collection, Setup & Hire, Out Of Hours", price: 1600 },
                        { code: "MTS76", description: "TM Drawings & Planning", price: 75 }
                    ]
                },
                ONSA_PED_CROSSING: {
                    onInvoice: true, onAfp: true,
                    standardItems: [
                        { code: "MTS25", description: "Pedestrian Crossing Set Delivery, Collection, Setup & Hire, In Hours - Per 2-Way Crossing", price: 475 }
                    ],
                    oohItems: [
                        { code: "MTS26", description: "Pedestrian Crossing Set Delivery, Collection, Setup & Hire, Out of Hrs - Per 2-Way Crossing", price: 550 }
                    ]
                },
                ONSA_RC_25: {
                    onInvoice: true, onAfp: false, 
                    standardItems: [
                        { code: "MTS27", description: "Road Closure & Diversion Up to 25 Signs, Delivery, Setup & Hire, In Hours (First Day)", price: 240 },
                        { code: "MTS28", description: "Road Closure & Diversion Up to 25 Signs, Dismantle, Collection & Hire, In Hours (First Day)", price: 145 },
                        { code: "MTS76", description: "TM Drawings & Planning", price: 75},
                        { code: "MTS62", description: "Letterdrop", price: 155 }, 
	                    { code: "MTS54", description: "Advance Warning Sign for Road Closures & Specials.", price: 60 } 
                    ],
                    oohItems: [
                        { code: "MTS30", description: "Road Closure & Diversion Up to 25 Signs, Delivery, Setup & Hire, Out of Hours (First Day)", price: 325 },
                        { code: "MTS31", description: "Road Closure & Diversion Up to 25 Signs, Dismantle, Collection & Hire, Out of Hours (First Day)", price: 205 },
                        { code: "MTS76", description: "TM Drawings & Planning", price: 75},
                        { code: "MTS62", description: "Letterdrop", price: 155 },
	                    { code: "MTS54", description: "Advance Warning Sign for Road Closures & Specials.", price: 60 }
                    ],
                    secondDayItems: [
                        { code: "MTS29", description: "Road Closure & Diversion Up to 25 Signs, Daily Hire Second Day Onwards", price: 40 }
                    ]
                },
                ONSA_RC_60: {
                    onInvoice: true, onAfp: false,
                    standardItems: [
                        { code: "MTS32", description: "Road Closure & Diversion Up to 60 Signs, Delivery, Setup & Hire, In Hours (First Day)", price: 323 },
                        { code: "MTS33", description: "Road Closure & Diversion Up to 60 Signs, Dismantle, Collection & Hire, In Hours (First Day)", price: 188 },
                        { code: "MTS76", description: "TM Drawings & Planning", price: 75},
                        { code: "MTS62", description: "Letterdrop", price: 155 },
	                    { code: "MTS54", description: "Advance Warning Sign for Road Closures & Specials.", price: 60 }
                    ],
                    oohItems: [
                        { code: "MTS35", description: "Road Closure & Diversion Up to 60 Signs, Delivery, Setup & Hire, Out of Hours (First Day)", price: 457 }, 
                        { code: "MTS36", description: "Road Closure & Diversion Up to 60 Signs, Dismantle, Collection & Hire, Out of Hours (First Day)", price: 223 }, 
                        { code: "MTS76", description: "TM Drawings & Planning", price: 75},
                        { code: "MTS62", description: "Letterdrop", price: 155 },
	                    { code: "MTS54", description: "Advance Warning Sign for Road Closures & Specials.", price: 60 }
                    ],
                    secondDayItems: [
                        { code: "MTS34", description: "Road Closure & Diversion Up to 60 Signs, Daily Hire Second Day Onwards", price: 57 } 
                    ]
                },
                ONSA_RC_85: { 
                    onInvoice: true, onAfp: false,
                    standardItems: [
                        { code: "MTS32", description: "Road Closure & Diversion Up to 60 Signs, Delivery, Setup & Hire, In Hours (First Day)", price: 323 },
                        { code: "MTS33", description: "Road Closure & Diversion Up to 60 Signs, Dismantle, Collection & Hire, In Hours (First Day)", price: 188 },
                        { code: "MTS27", description: "Road Closure & Diversion Up to 25 Signs, Delivery, Setup & Hire, In Hours (First Day)", price: 240 },
                        { code: "MTS28", description: "Road Closure & Diversion Up to 25 Signs, Dismantle, Collection & Hire, In Hours (First Day)", price: 145 },
                        { code: "MTS76", description: "TM Drawings & Planning", price: 75},
                        { code: "MTS62", description: "Letterdrop", price: 155 },
	                    { code: "MTS54", description: "Advance Warning Sign for Road Closures & Specials.", price: 60 }
                    ],
                    oohItems: [
                        { code: "MTS35", description: "Road Closure & Diversion Up to 60 Signs, Delivery, Setup & Hire, Out of Hours (First Day)", price: 457 },
                        { code: "MTS36", description: "Road Closure & Diversion Up to 60 Signs, Dismantle, Collection & Hire, Out of Hours (First Day)", price: 223 },
                        { code: "MTS30", description: "Road Closure & Diversion Up to 25 Signs, Delivery, Setup & Hire, Out of Hours (First Day)", price: 325 },
                        { code: "MTS31", description: "Road Closure & Diversion Up to 25 Signs, Dismantle, Collection & Hire, Out of Hours (First Day)", price: 205 },
                        { code: "MTS76", description: "TM Drawings & Planning", price: 75},
                        { code: "MTS62", description: "Letterdrop", price: 155 },
	                    { code: "MTS54", description: "Advance Warning Sign for Road Closures & Specials.", price: 60 }
                    ],
                    secondDayItems: [
                        { code: "MTS34", description: "Road Closure & Diversion Up to 60 Signs, Daily Hire Second Day Onwards", price: 57 },
                        { code: "MTS29", description: "Road Closure & Diversion Up to 25 Signs, Daily Hire Second Day Onwards", price: 40 }
                    ]
                },
                ONSA_RC_NTR: {
                    onInvoice: true, onAfp: true,
                    standardItems: [ 
                        { code: "MTS54 x 2", description: "Advance Warning Sign for Road Closures & Specials.", price: 60 },
                        { code: "MTS58", description: "TM Operative hours on site.", price: 25 },
                        { code: "MTS62", description: "Letterdrop", price: 155 },
                        { code: "MTS76", description: "TM Drawings & Planning", price: 75 }
                    ]
                },
                ONSA_STOP_GO_2: {
                    onInvoice: true, onAfp: true,
                    standardItems: [
                        { code: "MTS 2.1", description: "Stop & Go 2 Operative Manual Control - Above 40MPH to 60 MPH. Including travel to & from site", price: 425 }
                    ],
                    oohItems: [
                        { code: "MTS 2.2", description: "Stop & Go 2 Operative Manual Control Out of Hours - Above 40MPH to 60 MPH. Including travel to & from site.", price: 540 }
                    ]
                },
                ONSA_STOP_GO_3: {
                    onInvoice: true, onAfp: true,
                    standardItems: [
                        { code: "MTS 3", description: "Stop & Go 3 Operative Manual Control. Including travel to & from site.", price: 565 }
                    ],
                    oohItems: [
                        { code: "MTS 4", description: "Stop & Go 3 Operative Manual Control Out of Hours. Including travel to & from site.", price: 705 }
                    ]
                },
                ONSA_STOP_GO_4: {
                    onInvoice: true, onAfp: true,
                    standardItems: [
                        { code: "MTS 5", description: "Stop & Go 4 Operative Manual Control. Including travel to & from site.", price: 660 }
                    ],
                    oohItems: [
                        { code: "MTS 6", description: "Stop & Go 4 Operative Manual Control Out of Hours. Including travel to & from site.", price: 830 }
                    ]
                },
                ONSA_TM_PLAN_ONLY: {
                    onInvoice: true, onAfp: true,
                    standardItems: [
                        { code: "MTS76", description: "TM Drawings & Planning", price: 75 }
                    ]
                },
                ONSA_TO15: {
                    onInvoice: true, onAfp: false, 
                    standardItems: [
                        { code: "MTS77", description: "TO15 - Traffic control by \"Temporary Obstruction\" sign in line with all NRSWA requirements", price: 975 },
                        { code: "MTS76", description: "TM Drawings & Planning", price: 75 }
                    ]
                },
                ONSA_TO15_NTR: {
                    onInvoice: true, onAfp: true,
                    standardItems: [
                        { code: "MTS54 x 2", description: "Advance Warning Sign for Road Closures & Specials. Evidence of use required.", price: 60 },
                        { code: "MTS58", description: "TM Operative hours on site", price: 25 },
                        { code: "MTS76", description: "TM Drawings & Planning", price: 75 }
                    ]
                },
                PED_LIGHTS_ONSA: { 
                    onInvoice: true, onAfp: true,
                    standardItems: [{ code: "MTS25", description: "Pedestrian Crossing Set Delivery, Collection, Setup & Hire, In Hours - Per 2-Way Crossing", price: 475 }],
                    oohItems: [{ code: "MTS26", description: "Pedestrian Crossing Set Delivery, Collection, Setup & Hire, Out of Hrs - Per 2-Way Crossing", price: 550 }]
                },
                ADD_TM_PLAN_ONSA: { 
                    onInvoice: true, onAfp: true,
                    standardItems: [{ code: "MTS76", description: "TM Drawings & Planning", price: 75 }]
                },
                SPECIAL_SIGNS_ONSA: { 
                    onInvoice: true, onAfp: true,
                    standardItems: [{ code: "MTS54", description: "Advance Warning Sign for Road Closures & Specials. Evidence of use required.", price: 60 }]
                },
                MAN_CON_ONSA: { 
                    onInvoice: true, onAfp: true,
                    standardItems: [{ code: "MTS58", description: "TM Operative hours on site", price: 25 }]
                },
                BSS_ADD_ONSA: { 
                    onInvoice: true, onAfp: true,
                    standardItems: [{ code: "MTS70", description: "TBA", price: 0 }] 
                },
                PRE_CONE_ONSA: { 
                     onInvoice: true, onAfp: false, 
                     specialAction: "I&A Invoice",
                     standardItems: [{ code: "MTS63", description: "Installation, Hire and Collection of upto 25 'No Parking Cones'", price: 215 }]
                }
            };

            function handleExclusivity(checkboxes, currentCheckbox) {
                checkboxes.forEach(cb => {
                    if (cb !== currentCheckbox) cb.checked = false;
                });
            }

            [...contractTypeCheckboxes, ...trafficManagementCheckboxes].forEach(groupMember => {
                groupMember.addEventListener('change', () => {
                    if (groupMember.checked) {
                        if (groupMember.name === "contractType") handleExclusivity(contractTypeCheckboxes, groupMember);
                        if (groupMember.name === "trafficManagement") handleExclusivity(trafficManagementCheckboxes, groupMember);
                    }
                    updateOutput();
                });
            });

            [
                manualControlCheckbox, oohCheckbox, pedSetsCheckbox, 
                additionalTmPlanCheckbox, specialSignsCheckbox, bssCheckbox, 
                moreThan12HoursCheckbox, emergencyCheckbox 
            ].forEach(checkbox => {
                checkbox.addEventListener('change', updateOutput);
            });
            
            function getSelectedValue(checkboxGroup) {
                for (const checkbox of checkboxGroup) {
                    if (checkbox.checked) return checkbox.value;
                }
                return null;
            }

            function generateTable(containerElement, title, items) {
                containerElement.innerHTML = '';
                if (items.length === 0) return;
                const uniqueItems = items.reduce((acc, current) => {
                    const x = acc.find(item => item.code === current.code && item.description === current.description);
                    if (!x) return acc.concat([current]);
                    return acc;
                }, []);

                let tableHtml = `<h3 class="text-lg font-semibold text-gray-600 mb-2">${title}</h3>`;
                tableHtml += '<div class="overflow-x-auto rounded-lg shadow-md">';
                tableHtml += '<table class="min-w-full bg-white output-table">';
                tableHtml += '<thead><tr><th>Code</th><th>Description</th><th>Price</th></tr></thead>';
                tableHtml += '<tbody class="divide-y divide-gray-200">';
                uniqueItems.forEach(item => {
                    tableHtml += `<tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${item.code || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.description || 'N/A'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">£${(item.price || 0).toFixed(2)}</td>
                    </tr>`;
                });
                tableHtml += '</tbody></table></div>';
                containerElement.innerHTML = tableHtml;
            }

            function manageConflicts(selectedTMValue) {
                [additionalTmPlanCheckbox, bssCheckbox, pedSetsCheckbox].forEach(cb => {
                    cb.disabled = false;
                });

                if (selectedTMValue === "TM Plan only") {
                    additionalTmPlanCheckbox.checked = false; 
                    additionalTmPlanCheckbox.disabled = true;
                } else if (selectedTMValue === "Bus Stop Suspension") {
                    bssCheckbox.checked = false; 
                    bssCheckbox.disabled = true;
                } else if (selectedTMValue === "Ped Crossing Only") {
                    pedSetsCheckbox.checked = false; 
                    pedSetsCheckbox.disabled = true;
                }
            }
            
            function updateOutput() {
                const selectedContractType = getSelectedValue(contractTypeCheckboxes);
                const selectedTrafficManagement = getSelectedValue(trafficManagementCheckboxes);
                const isMoreThanOneDay = moreThan12HoursCheckbox.checked; 
                const isOoh = oohCheckbox.checked; 
                const isEmergency = emergencyCheckbox.checked;

                let invoiceItems = [];
                let afpItems = []; 
                let additionalNotes = []; 
                let mainMessageText = "Please make a selection from Contract Type and Traffic Management categories.";
                let isSpecialActionIA = false; 

                invoiceTableContainer.innerHTML = '';
                afpTableContainer.innerHTML = ''; 
                additionalNotesContainer.innerHTML = '';
                invoiceActionIcon.classList.add('inactive');
                invoiceActionIcon.classList.remove('active');
                afpActionIcon.classList.add('inactive');
                afpActionIcon.classList.remove('active');
                iaInvoiceActionIcon.classList.add('inactive');
                iaInvoiceActionIcon.classList.remove('active');
                requestSlipActionIcon.classList.add('inactive'); 
                requestSlipActionIcon.classList.remove('active');
                actionIconsPlaceholder.classList.remove('hidden');

                manageConflicts(selectedTrafficManagement);

                if (selectedContractType && selectedTrafficManagement) {
                    mainMessageText = ""; 
                    let baseItemKey = null; 
                    let osaBaseItemCodes = []; 
                    
                    if (selectedContractType === "OSA") {
                        switch (selectedTrafficManagement) {
                            case "2 Way Lights (Up to 40mph)": osaBaseItemCodes.push("TM03_UPTO_TBA"); break;
                            case "2 Way Lights (Over 40mph)": osaBaseItemCodes.push("TM03_OVER"); break;
                            case "3 Way Lights": osaBaseItemCodes.push("TM04"); break;
                            case "4 Way Lights": osaBaseItemCodes.push("TM05"); break;
                            case "5 Way Lights": osaBaseItemCodes.push("TM03_OVER", "TM04"); break; 
                            case "Bus Stop Suspension": osaBaseItemCodes.push("BUS_SUS"); break;
                            case "Footpath Closure": osaBaseItemCodes.push("FOOT_CLOS"); break;
                            case "Lane Closure (Up to 40mph)": osaBaseItemCodes.push("TM08_UPTO"); break;
                            case "Lane Closure (Over 40mph)": osaBaseItemCodes.push("TM08_OVER"); break;
                            case "Ped Crossing Only": osaBaseItemCodes.push("TM10_PC"); break;
                            case "Pre Cone": osaBaseItemCodes.push("PRE_CONE"); break;
                            case "Road Closure Up to 25 Signs":
                            case "Road Closure Up to 60 signs":
                            case "Road Closure Up to 85 signs":
                                osaBaseItemCodes.push("TM09"); 
                                break;
                            case "Road Closure NTR": osaBaseItemCodes.push("TM22_RC_NTR"); break;
                            case "Stop and Go 2 Way": osaBaseItemCodes.push("TM19"); break;
                            case "Stop and Go 3 Way": osaBaseItemCodes.push("TM20"); break;
                            case "Stop and Go 4 Way": osaBaseItemCodes.push("TM21"); break;
                            case "TM Plan only": osaBaseItemCodes.push("TM16_PLAN"); break;
                            case "TO15": osaBaseItemCodes.push("TM13"); break;
                            case "TO15 NTR": osaBaseItemCodes.push("TM22_TO15_NTR"); break;
                        }

                        let tempSelectedTmItemData = null;
                        if (osaBaseItemCodes.length > 0) {
                             if (selectedTrafficManagement === "5 Way Lights") {
                                 if (quoteItemsData["TM03_OVER"]?.specialAction === "I&A Invoice") { 
                                    tempSelectedTmItemData = quoteItemsData["TM03_OVER"];
                                 } else if (quoteItemsData["TM03_UPTO_TBA"]?.specialAction === "I&A Invoice") { 
                                    tempSelectedTmItemData = quoteItemsData["TM03_UPTO_TBA"];
                                 } else {
                                     tempSelectedTmItemData = quoteItemsData[osaBaseItemCodes.find(code => quoteItemsData[code]?.specialAction === "I&A Invoice")] || quoteItemsData[osaBaseItemCodes[0]];
                                 }
                            } else { 
                                for (const code of osaBaseItemCodes) {
                                    if (quoteItemsData[code]?.specialAction === "I&A Invoice") {
                                        tempSelectedTmItemData = quoteItemsData[code];
                                        break; 
                                    }
                                }
                                if (!tempSelectedTmItemData) tempSelectedTmItemData = quoteItemsData[osaBaseItemCodes[0]];
                            }
                        }
                        isSpecialActionIA = tempSelectedTmItemData?.specialAction === "I&A Invoice";

                        osaBaseItemCodes.forEach(code => {
                            const item = quoteItemsData[code];
                            if (item) {
                                if (item.onInvoice) invoiceItems.push(item);
                                if (item.onAfp && !isSpecialActionIA) { 
                                    afpItems.push(item);
                                }
                                if (isMoreThanOneDay && item.has12hrVariant && quoteItemsData[item.has12hrVariant]) { 
                                    const twelveHrItem = quoteItemsData[item.has12hrVariant];
                                    if (twelveHrItem.onInvoice) invoiceItems.push(twelveHrItem);
                                    if (twelveHrItem.onAfp && !isSpecialActionIA) {
                                        afpItems.push(twelveHrItem);
                                    }
                                }
                            }
                        });
                        
                        const osaAdditionalReqMap = {
                            manualControl: 'TM11', ooh: 'TM14', pedSets: 'TM10_PedSet',
                            additionalTmPlan: 'TM16_ADD', specialSigns: 'SPEC_SIGNS', bss: 'BSS_ADD'
                        };
                        Object.entries(osaAdditionalReqMap).forEach(([cbId, itemCode]) => {
                            const cbElement = document.getElementById(cbId);
                            if (cbElement && cbElement.checked && !cbElement.disabled) {
                                const item = quoteItemsData[itemCode];
                                if (item) {
                                    if (item.onInvoice) invoiceItems.push(item);
                                    if (item.onAfp && !isSpecialActionIA) afpItems.push(item);
                                     if (isMoreThanOneDay && item.has12hrVariant && quoteItemsData[item.has12hrVariant]) { 
                                        const twelveHrAddItem = quoteItemsData[item.has12hrVariant];
                                        if(twelveHrAddItem.onInvoice) invoiceItems.push(twelveHrAddItem);
                                        if(twelveHrAddItem.onAfp && !isSpecialActionIA) afpItems.push(twelveHrAddItem);
                                    }
                                    if (item.additionalNote === "I&A Invoice") { 
                                        additionalNotes.push(`${item.description} requires an I&A Invoice.`);
                                    }
                                }
                            }
                        });


                    } else if (selectedContractType === "ONSA") {
                        isSpecialActionIA = false; 
                        switch (selectedTrafficManagement) {
                            case "2 Way Lights (Up to 40mph)": baseItemKey = "ONSA_2_WAY_UPTO"; break; 
                            case "2 Way Lights (Over 40mph)": baseItemKey = "ONSA_2_WAY_OVER_40"; break;
                            case "3 Way Lights": baseItemKey = "ONSA_3_WAY"; break;
                            case "4 Way Lights": baseItemKey = "ONSA_4_WAY"; break;
                            case "5 Way Lights": baseItemKey = "ONSA_5_WAY"; break; 
                            case "Bus Stop Suspension": baseItemKey = "ONSA_BUS_SUSPENSION"; break; 
                            case "Footpath Closure": baseItemKey = "ONSA_FOOTPATH_CLOSURE"; break;
                            case "Lane Closure (Up to 40mph)": baseItemKey = "ONSA_LANE_CLOSURE_UPTO"; break; 
                            case "Lane Closure (Over 40mph)": baseItemKey = "ONSA_LANE_CLOSURE_OVER_40"; break;
                            case "Ped Crossing Only": baseItemKey = "ONSA_PED_CROSSING"; break;
                            case "Pre Cone": baseItemKey = "PRE_CONE_ONSA"; break; 
                            case "Road Closure Up to 25 Signs": baseItemKey = "ONSA_RC_25"; break;
                            case "Road Closure Up to 60 signs": baseItemKey = "ONSA_RC_60"; break;
                            case "Road Closure Up to 85 signs": baseItemKey = "ONSA_RC_85"; break;
                            case "Road Closure NTR": baseItemKey = "ONSA_RC_NTR"; break;
                            case "Stop and Go 2 Way": baseItemKey = "ONSA_STOP_GO_2"; break;
                            case "Stop and Go 3 Way": baseItemKey = "ONSA_STOP_GO_3"; break;
                            case "Stop and Go 4 Way": baseItemKey = "ONSA_STOP_GO_4"; break;
                            case "TM Plan only": baseItemKey = "ONSA_TM_PLAN_ONLY"; break;
                            case "TO15": baseItemKey = "ONSA_TO15"; break;
                            case "TO15 NTR": baseItemKey = "ONSA_TO15_NTR"; break;
                            default: 
                                const tmValueClean = selectedTrafficManagement.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '');
                                baseItemKey = `${selectedContractType}_${tmValueClean}_TBA`; 
                                if (!quoteItemsData[baseItemKey]) { 
                                    quoteItemsData[baseItemKey] = { 
                                        standardItems: [{ code: "TBA", description: `${selectedContractType} - ${selectedTrafficManagement} (Details TBA)`, price: 0 }],
                                        onInvoice: true, onAfp: true 
                                    };
                                }
                                break;
                        }
                        
                        let itemsToProcess = [];
                        let tmDataForProcessing = null; 

                        if (baseItemKey === "ONSA_5_WAY") { 
                            const twoWayData = quoteItemsData["ONSA_2_WAY_OVER_40"];
                            const threeWayData = quoteItemsData["ONSA_3_WAY"];
                            const itemsTwoWay = isOoh && twoWayData.oohItems ? twoWayData.oohItems : twoWayData.standardItems;
                            const itemsThreeWay = isOoh && threeWayData.oohItems ? threeWayData.oohItems : threeWayData.standardItems;
                            itemsToProcess.push(...(itemsTwoWay || []));
                            itemsToProcess.push(...(itemsThreeWay || []));

                            if (isMoreThanOneDay) { 
                                if(twoWayData.secondDayItems) itemsToProcess.push(...twoWayData.secondDayItems);
                                if(threeWayData.secondDayItems) itemsToProcess.push(...threeWayData.secondDayItems);
                            }
                            if (twoWayData.onInvoice || threeWayData.onInvoice) itemsToProcess.forEach(item => { if(item) invoiceItems.push(item); });
                            if (twoWayData.onAfp || threeWayData.onAfp) itemsToProcess.forEach(item => { if(item) afpItems.push(item); });
                            isSpecialActionIA = twoWayData?.specialAction === "I&A Invoice" || threeWayData?.specialAction === "I&A Invoice";


                        } else if (quoteItemsData[baseItemKey]) {
                            tmDataForProcessing = quoteItemsData[baseItemKey];
                            itemsToProcess = isOoh && tmDataForProcessing.oohItems ? tmDataForProcessing.oohItems : tmDataForProcessing.standardItems;
                            if (isMoreThanOneDay && tmDataForProcessing.secondDayItems) { 
                                itemsToProcess = itemsToProcess.concat(tmDataForProcessing.secondDayItems);
                            }
                            isSpecialActionIA = tmDataForProcessing.specialAction === "I&A Invoice"; 

                            if (tmDataForProcessing.onInvoice) itemsToProcess.forEach(item => { if(item) invoiceItems.push(item); });
                            if (tmDataForProcessing.onAfp && !isSpecialActionIA) itemsToProcess.forEach(item => { if(item) afpItems.push(item); });
                        }

                        const onsaAdditionalReqMap = {
                            manualControl: 'MAN_CON_ONSA', 
                            pedSets: 'PED_LIGHTS_ONSA', 
                            additionalTmPlan: 'ADD_TM_PLAN_ONSA', 
                            specialSigns: 'SPECIAL_SIGNS_ONSA', 
                            bss: 'BSS_ADD_ONSA'
                        };
                        Object.entries(onsaAdditionalReqMap).forEach(([cbId, itemKeySuffix]) => {
                            const cbElement = document.getElementById(cbId);
                            if (cbElement && cbElement.checked && !cbElement.disabled) {
                                const onsaItemData = quoteItemsData[itemKeySuffix];
                                if (onsaItemData) {
                                    const items = (isOoh && onsaItemData.oohItems) ? onsaItemData.oohItems : onsaItemData.standardItems;
                                    if (items) {
                                        if (onsaItemData.onInvoice) invoiceItems.push(...items);
                                        if (onsaItemData.onAfp) afpItems.push(...items); 
                                    }
                                }
                            }
                        });
                        if (isEmergency && (baseItemKey === "ONSA_RC_25" || baseItemKey === "ONSA_RC_60" || baseItemKey === "ONSA_RC_85")) {
                             invoiceItems = invoiceItems.filter(item => item.code !== "MTS62" && item.code !== "MTS54");
                             afpItems = afpItems.filter(item => item.code !== "MTS62" && item.code !== "MTS54");
                        }


                    } else { // Fibre Build 
                        const tmValueClean = selectedTrafficManagement.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '');
                        const itemKey = `${selectedContractType}_${tmValueClean}_TBA`;
                        if (!quoteItemsData[itemKey]) {
                            quoteItemsData[itemKey] = { 
                                standardItems: [{ code: "TBA", description: `${selectedContractType} - ${selectedTrafficManagement} (Details TBA)`, price: 0 }],
                                onInvoice: true, onAfp: true 
                            };
                        }
                        isSpecialActionIA = false; 
                        const tmData = quoteItemsData[itemKey];
                        if (tmData.onInvoice) invoiceItems.push(...tmData.standardItems);
                        if (tmData.onAfp) afpItems.push(...tmData.standardItems);
                    }

                    // Apply Emergency Fee only for OSA
                    if (isEmergency && selectedContractType === "OSA" && quoteItemsData.TM15) {
                        const emergencyItem = quoteItemsData.TM15;
                        if(emergencyItem.onInvoice && !invoiceItems.find(item => item.code === emergencyItem.code)) {
                            invoiceItems.push(emergencyItem);
                        }
                        if (isSpecialActionIA) { 
                            afpItems = [emergencyItem];
                        } else if (emergencyItem.onAfp && !afpItems.find(item => item.code === emergencyItem.code)) {
                           afpItems.push(emergencyItem); 
                        }
                    } else if (isSpecialActionIA && selectedContractType === "OSA") { 
                         afpItems = afpItems.filter(item => item.code === "TM15"); 
                         if (!isEmergency) afpItems = [];
                    }
                    
                    const anInvoiceIsNeeded = invoiceItems.length > 0;
                    const anAfpIsNeeded = afpItems.length > 0;

                    if (isSpecialActionIA) { 
                        iaInvoiceActionIcon.classList.remove('inactive');
                        iaInvoiceActionIcon.classList.add('active');
                        invoiceActionIcon.classList.add('inactive'); 
                        invoiceActionIcon.classList.remove('active');
                        
                        if (isEmergency && selectedContractType === "OSA" && anAfpIsNeeded) { 
                            afpActionIcon.classList.remove('inactive');
                            afpActionIcon.classList.add('active');
                        } else {
                            afpActionIcon.classList.add('inactive');
                            afpActionIcon.classList.remove('active');
                        }
                    } else { 
                        if (anInvoiceIsNeeded) {
                            invoiceActionIcon.classList.remove('inactive');
                            invoiceActionIcon.classList.add('active');
                        }
                        if (anAfpIsNeeded) { 
                            afpActionIcon.classList.remove('inactive');
                            afpActionIcon.classList.add('active');
                        }
                    }
                    
                    if (anInvoiceIsNeeded) generateTable(invoiceTableContainer, "Invoice Items", invoiceItems);
                    
                    if (isSpecialActionIA && selectedContractType === "OSA") { 
                        if (isEmergency && anAfpIsNeeded) { 
                            generateTable(afpTableContainer, "AFP Items (Emergency Only)", afpItems.filter(item => item.code === "TM15"));
                        } else {
                            afpTableContainer.innerHTML = ''; 
                        }
                    } else if (anAfpIsNeeded) { 
                        generateTable(afpTableContainer, "AFP Items", afpItems);
                    } else {
                         afpTableContainer.innerHTML = ''; 
                    }

                    if (additionalNotes.length > 0) {
                        let notesHtml = '<h4 class="text-md font-semibold text-gray-600 mt-4 mb-1">Additional Notes:</h4><ul>';
                        additionalNotes.forEach(note => {
                            notesHtml += `<li>${note}</li>`;
                        });
                        notesHtml += '</ul>';
                        additionalNotesContainer.innerHTML = notesHtml;
                    }

                    if (invoiceActionIcon.classList.contains('inactive') &&
                        afpActionIcon.classList.contains('inactive') &&
                        iaInvoiceActionIcon.classList.contains('inactive') &&
                        requestSlipActionIcon.classList.contains('inactive') ) { 
                        mainMessageText = "No specific quote actions identified for these selections.";
                         actionIconsPlaceholder.classList.remove('hidden'); 
                    } else {
                        actionIconsPlaceholder.classList.remove('hidden'); 
                    }
                } else {
                     actionIconsPlaceholder.classList.remove('hidden'); 
                }
                outputMessageElement.textContent = mainMessageText; 
            }
            updateOutput();
        });
    </script>
</body>
</html>
