<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTM Quote Assist Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        .checkbox-card {
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow-lg */
            transition: all 0.3s ease-in-out;
        }
        .checkbox-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); /* shadow-xl */
        }
        .checkbox-input {
            appearance: none;
            background-color: #fff;
            margin-right: 0.5rem;
            width: 1.25em;
            height: 1.25em;
            border: 2px solid #D1D5DB; /* Tailwind gray-300 */
            border-radius: 0.25em;
            transform: translateY(-0.075em);
            display: inline-grid;
            place-content: center;
            cursor: pointer;
            transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out;
        }
        .checkbox-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 2px #60a5fa; /* Tailwind blue-400 */
        }
        .checkbox-input::before {
            content: "";
            width: 0.75em;
            height: 0.75em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #2563eb; /* Tailwind blue-600 */
            background-color: CanvasText;
            transform-origin: bottom left;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .checkbox-input:checked {
            border-color: #2563eb; /* Tailwind blue-600 */
            background-color: #2563eb;
        }
        .checkbox-input:checked::before {
            transform: scale(1);
            box-shadow: inset 1em 1em #fff; /* White checkmark */
        }
        .checkbox-label {
            cursor: pointer;
            color: #374151; /* Tailwind gray-700 */
            transition: color 0.2s ease-in-out;
            user-select: none;
        }
        .checkbox-input:checked + .checkbox-label {
            color: #1d4ed8; /* Tailwind blue-700 */
            font-weight: 500;
        }
        /* Table styling */
        .output-table th, .output-table td {
            padding: 0.75rem 1rem; /* p-3 px-4 */
            text-align: left;
            font-size: 0.875rem; /* text-sm */
        }
        .output-table th {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #374151; /* text-gray-700 */
            font-weight: 600; /* font-semibold */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .output-table td {
            color: #1f2937; /* text-gray-800 */
            border-bottom: 1px solid #e5e7eb; /* border-b border-gray-200 */
        }
        .output-table tr:last-child td {
            border-bottom: none;
        }
        .scrollable-checkbox-group {
            max-height: 200px; /* Adjust as needed */
            overflow-y: auto;
            padding-right: 0.5rem; /* For scrollbar */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 sm:p-6">

    <div class="w-full max-w-6xl bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">RTM Quote Assist Tool</h1>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="checkbox-card">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Contract Type</h2>
                <div class="space-y-3">
                    <div>
                        <input type="checkbox" id="osa" name="contractType" value="OSA" class="checkbox-input">
                        <label for="osa" class="checkbox-label">OSA LOT 2.0</label>
                    </div>
                    <div>
                        <input type="checkbox" id="onsa" name="contractType" value="ONSA" class="checkbox-input">
                        <label for="onsa" class="checkbox-label">ONSA</label>
                    </div>
                    <div>
                        <input type="checkbox" id="fibre" name="contractType" value="Fibre Build" class="checkbox-input">
                        <label for="fibre" class="checkbox-label">Fibre Build</label>
                    </div>
                </div>
            </div>

            <div class="checkbox-card">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Traffic Management</h2>
                <div class="space-y-3 scrollable-checkbox-group">
                    <div><input type="checkbox" id="tmTwoWayLights" name="trafficManagement" value="2 Way Lights (40mph>)" class="checkbox-input"><label for="tmTwoWayLights" class="checkbox-label">2 Way Lights (40mph&gt;)</label></div>
                    <div><input type="checkbox" id="tmThreeWayLights" name="trafficManagement" value="3 Way Lights" class="checkbox-input"><label for="tmThreeWayLights" class="checkbox-label">3 Way Lights</label></div>
                    <div><input type="checkbox" id="tmFourWayLights" name="trafficManagement" value="4 Way Lights" class="checkbox-input"><label for="tmFourWayLights" class="checkbox-label">4 Way Lights</label></div>
                    <div><input type="checkbox" id="tmFiveWayLights" name="trafficManagement" value="5 Way Lights" class="checkbox-input"><label for="tmFiveWayLights" class="checkbox-label">5 Way Lights</label></div>
                    <div><input type="checkbox" id="tmBusStopSuspension" name="trafficManagement" value="Bus Stop Suspension" class="checkbox-input"><label for="tmBusStopSuspension" class="checkbox-label">Bus Stop Suspension</label></div>
                    <div><input type="checkbox" id="tmFootpathClosure" name="trafficManagement" value="Footpath Closure" class="checkbox-input"><label for="tmFootpathClosure" class="checkbox-label">Footpath Closure</label></div>
                    <div><input type="checkbox" id="tmLaneClosure" name="trafficManagement" value="Lane Closure" class="checkbox-input"><label for="tmLaneClosure" class="checkbox-label">Lane Closure</label></div>
                    <div><input type="checkbox" id="tmPedCrossingOnly" name="trafficManagement" value="Ped Crossing Only" class="checkbox-input"><label for="tmPedCrossingOnly" class="checkbox-label">Ped Crossing Only</label></div>
                    <div><input type="checkbox" id="tmPreCone" name="trafficManagement" value="Pre Cone" class="checkbox-input"><label for="tmPreCone" class="checkbox-label">Pre Cone</label></div>
                    <div><input type="checkbox" id="tmRoadClosure" name="trafficManagement" value="Road closure" class="checkbox-input"><label for="tmRoadClosure" class="checkbox-label">Road closure</label></div>
                    <div><input type="checkbox" id="tmRoadClosureNTR" name="trafficManagement" value="Road Closure NTR" class="checkbox-input"><label for="tmRoadClosureNTR" class="checkbox-label">Road Closure NTR</label></div>
                    <div><input type="checkbox" id="tmStopGo2Way" name="trafficManagement" value="Stop and Go 2 Way" class="checkbox-input"><label for="tmStopGo2Way" class="checkbox-label">Stop and Go 2 Way</label></div>
                    <div><input type="checkbox" id="tmStopGo3Way" name="trafficManagement" value="Stop and Go 3 Way" class="checkbox-input"><label for="tmStopGo3Way" class="checkbox-label">Stop and Go 3 Way</label></div>
                    <div><input type="checkbox" id="tmStopGo4Way" name="trafficManagement" value="Stop and Go 4 Way" class="checkbox-input"><label for="tmStopGo4Way" class="checkbox-label">Stop and Go 4 Way</label></div>
                    <div><input type="checkbox" id="tmPlanOnly" name="trafficManagement" value="TM Plan only" class="checkbox-input"><label for="tmPlanOnly" class="checkbox-label">TM Plan only</label></div>
                    <div><input type="checkbox" id="tmTO15" name="trafficManagement" value="TO15" class="checkbox-input"><label for="tmTO15" class="checkbox-label">TO15</label></div>
                    <div><input type="checkbox" id="tmTO15NTR" name="trafficManagement" value="TO15 NTR" class="checkbox-input"><label for="tmTO15NTR" class="checkbox-label">TO15 NTR</label></div>
                </div>
            </div>

            <div class="checkbox-card">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Additional Requirements</h2>
                <div class="space-y-3">
                    <div>
                        <input type="checkbox" id="manualControl" name="additional" value="Manual Control" class="checkbox-input">
                        <label for="manualControl" class="checkbox-label">Manual Control</label>
                    </div>
                    <div>
                        <input type="checkbox" id="ooh" name="additional" value="OOH" class="checkbox-input">
                        <label for="ooh" class="checkbox-label">OOH</label>
                    </div>
                    <div>
                        <input type="checkbox" id="pedSets" name="additional" value="Ped Sets" class="checkbox-input">
                        <label for="pedSets" class="checkbox-label">Ped Sets</label>
                    </div>
                    <hr class="my-3 border-gray-300">
                    <div>
                        <input type="checkbox" id="moreThan12Hours" name="duration" value="More than 12 hours" class="checkbox-input">
                        <label for="moreThan12Hours" class="checkbox-label">Is it more than 12 hours?</label>
                    </div>
                    <div>
                        <input type="checkbox" id="emergency" name="urgency" value="Emergency" class="checkbox-input">
                        <label for="emergency" class="checkbox-label">Is emergency?</label>
                    </div>
                </div>
            </div>
        </div>

        <div id="outputContainer" class="bg-blue-50 p-6 rounded-lg shadow-inner">
            <p id="outputMessage" class="text-lg sm:text-xl text-blue-700 font-medium text-center mb-4">Please make a selection from Contract Type and Traffic Management categories.</p>
            <div id="invoiceTableContainer" class="mb-6"></div>
            <div id="afpTableContainer"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const contractTypeCheckboxes = document.querySelectorAll('input[name="contractType"]');
            const trafficManagementCheckboxes = document.querySelectorAll('input[name="trafficManagement"]');
            const additionalCheckboxes = document.querySelectorAll('input[name="additional"]'); // Keep this for existing logic if any
            const manualControlCheckbox = document.getElementById('manualControl');
            const oohCheckbox = document.getElementById('ooh');
            const pedSetsCheckbox = document.getElementById('pedSets');
            const moreThan12HoursCheckbox = document.getElementById('moreThan12Hours');
            const emergencyCheckbox = document.getElementById('emergency');
            const outputMessageElement = document.getElementById('outputMessage');
            const invoiceTableContainer = document.getElementById('invoiceTableContainer');
            const afpTableContainer = document.getElementById('afpTableContainer');

            // Data for quote items
            // Prices are numbers. onInvoice/onAfp are booleans.
            // has12hrVariant links to the code of the 12hr+ version of the item.
            const quoteItemsData = {
                // OSA LOT 2.0 Items from Document
                TM03: { code: "TM03", description: "Traffic control (two-way signals) road speed above 40mph", price: 400, onInvoice: true, onAfp: true, has12hrVariant: "TM3A" },
                TM3A: { code: "TM3A", description: "Traffic control (two-way signals) road speed above 40mph additional 12 Hours", price: 30, onInvoice: true, onAfp: true },
                TM04: { code: "TM04", description: "Traffic control (three-way signals)", price: 440, onInvoice: true, onAfp: true, has12hrVariant: "TM4A" },
                TM4A: { code: "TM4A", description: "Traffic control (three-way signals) additional 12 hours", price: 40, onInvoice: true, onAfp: true },
                TM05: { code: "TM05", description: "Traffic control (four way signals or above)", price: 470, onInvoice: true, onAfp: true, has12hrVariant: "TM5A" }, // Doc says "three-way signals" for TM05 desc, but TM5A says "four way". Using "four way" for TM05 for consistency.
                TM5A: { code: "TM5A", description: "Traffic control (four way signals or above) additional 12 hours", price: 50, onInvoice: true, onAfp: true },
                // For "5 Way Lights", it's a combination of TM03 and TM04. This is handled in the logic.

                BUS_SUS: { code: "TBA", description: "Bus Stop Suspension - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true, has12hrVariant: "BUS_SUS_12HR" },
                BUS_SUS_12HR: { code: "TBA", description: "Bus Stop Suspension additional 12 hours - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true },
                FOOT_CLOS: { code: "TBA", description: "Footpath Closure - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true, has12hrVariant: "FOOT_CLOS_12HR" },
                FOOT_CLOS_12HR: { code: "TBA", description: "Footpath Closure additional 12 hours - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true },
                
                TM08: { code: "TM08", description: "Lane closure (Dual Carriageway or Motorway)", price: 845, onInvoice: true, onAfp: false, has12hrVariant: "TM8A" },
                TM8A: { code: "TM8A", description: "Lane closure (Dual Carriageway or Motorway) additional 12 hours", price: 845, onInvoice: true, onAfp: false },
                
                // TM10 is also used for "Ped Sets" under additional requirements.
                TM10_PC: { code: "TM10", description: "Temporary signalised pedestrian crossing initial 12 hours synthetic (Ped Crossing Only TM)", price: 225, onInvoice: true, onAfp: true, has12hrVariant: "TMA0_PC" },
                TMA0_PC: { code: "TMA0", description: "Temporary signalised pedestrian additional 12 hours (Ped Crossing Only TM)", price: 25, onInvoice: true, onAfp: true },

                PRE_CONE: { code: "TBA", description: "Pre Cone - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true, has12hrVariant: "PRE_CONE_12HR" },
                PRE_CONE_12HR: { code: "TBA", description: "Pre Cone additional 12 hours - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true },

                TM09: { code: "TM09", description: "Road Closure (With Diversion Route)", price: 650, onInvoice: true, onAfp: false, has12hrVariant: "TM9A" },
                TM9A: { code: "TM9A", description: "Road Closure (With Diversion Route) additional 12 hours", price: 30, onInvoice: true, onAfp: false },
                
                TM22_RC_NTR: { code: "TM22", description: "Road Closure NTR", price: 495, onInvoice: true, onAfp: true, has12hrVariant: "TM22_RC_NTR_12HR" }, // Assuming 12hr is Ask Kyle -> TBA
                TM22_RC_NTR_12HR: { code: "TBA", description: "Road Closure NTR additional 12 hours - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true },

                TM19: { code: "TM19", description: "Stop & Go 2 Operative Manual Control", price: 495, onInvoice: true, onAfp: true, has12hrVariant: "TM19_12HR" },
                TM19_12HR: { code: "TBA", description: "Stop & Go 2 Operative Manual Control additional 12 hours - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true },
                TM20: { code: "TM20", description: "Stop & Go 3 Operative Manual Control", price: 585, onInvoice: true, onAfp: true, has12hrVariant: "TM20_12HR" },
                TM20_12HR: { code: "TBA", description: "Stop & Go 3 Operative Manual Control additional 12 hours - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true },
                TM21: { code: "TM21", description: "Stop & Go 4 Operative Manual Control", price: 675, onInvoice: true, onAfp: true, has12hrVariant: "TM21_12HR" },
                TM21_12HR: { code: "TBA", description: "Stop & Go 4 Operative Manual Control additional 12 hours - Details TBA (Ask Kyle)", price: 0, onInvoice: true, onAfp: true },

                TM16: { code: "TM16", description: "CAD Drawing - Over 40mph inc Multiway Lights (TM Plan only)", price: 70.20, onInvoice: true, onAfp: true }, // No 12hr variant specified

                TM13: { code: "TM13", description: "Temporary carriageway closure TO15", price: 690, onInvoice: true, onAfp: false }, // No 12hr variant in doc for this specific TO15 under OSA
                
                TM22_TO15_NTR: { code: "TM22", description: "TO15 NTR", price: 495, onInvoice: true, onAfp: true }, // No 12hr variant specified for this specific TM22

                // Additional Requirements (can be used across contract types)
                TM11: { code: "TM11", description: "Labour only for Manual control of signalised Traffic Management", price: 23.50, onInvoice: true, onAfp: true }, // Manual Control
                TM14: { code: "TM14", description: "Out of Hours attendance for Traffic Management", price: 27.50, onInvoice: true, onAfp: false }, // OOH
                TM10_PedSet: { code: "TM10", description: "Temporary signalised pedestrian crossing initial 12 hours synthetic (Ped Sets)", price: 225, onInvoice: true, onAfp: true, has12hrVariant: "TMA0_PedSet" }, // Ped Sets
                TMA0_PedSet: { code: "TMA0", description: "Temporary signalised pedestrian additional 12 hours (Ped Sets)", price: 25, onInvoice: true, onAfp: true },

                // Emergency Fee
                TM15: { code: "TM15", description: "Emergency Call Out Fee", price: 90, onInvoice: false, onAfp: true },
            };

            function handleExclusivity(checkboxes, currentCheckbox) {
                checkboxes.forEach(cb => {
                    if (cb !== currentCheckbox) cb.checked = false;
                });
            }

            [...contractTypeCheckboxes, ...trafficManagementCheckboxes].forEach(groupMember => {
                groupMember.addEventListener('change', () => {
                    if (groupMember.checked) {
                        if (groupMember.name === "contractType") handleExclusivity(contractTypeCheckboxes, groupMember);
                        if (groupMember.name === "trafficManagement") handleExclusivity(trafficManagementCheckboxes, groupMember);
                    }
                    updateOutput();
                });
            });

            [manualControlCheckbox, oohCheckbox, pedSetsCheckbox, moreThan12HoursCheckbox, emergencyCheckbox].forEach(checkbox => {
                checkbox.addEventListener('change', updateOutput);
            });

            function getSelectedValue(checkboxGroup) {
                for (const checkbox of checkboxGroup) {
                    if (checkbox.checked) return checkbox.value;
                }
                return null;
            }

            function generateTable(containerElement, title, items) {
                containerElement.innerHTML = '';
                if (items.length === 0) return;

                let tableHtml = `<h3 class="text-lg font-semibold text-gray-600 mb-2">${title}</h3>`;
                tableHtml += '<div class="overflow-x-auto rounded-lg shadow-md">';
                tableHtml += '<table class="min-w-full bg-white output-table">';
                tableHtml += '<thead><tr>';
                tableHtml += '<th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Code</th>';
                tableHtml += '<th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Description</th>';
                tableHtml += '<th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Price</th>';
                tableHtml += '</tr></thead>';
                tableHtml += '<tbody class="divide-y divide-gray-200">';
                items.forEach(item => {
                    tableHtml += `<tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${item.code}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.description}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">Â£${item.price.toFixed(2)}</td>
                    </tr>`;
                });
                tableHtml += '</tbody></table></div>';
                containerElement.innerHTML = tableHtml;
            }
            
            function addQuoteItem(itemCode, itemsList, is12hr) {
                if (!itemCode || !quoteItemsData[itemCode]) return;
                const item = quoteItemsData[itemCode];
                itemsList.push(item);

                if (is12hr && item.has12hrVariant && quoteItemsData[item.has12hrVariant]) {
                    itemsList.push(quoteItemsData[item.has12hrVariant]);
                }
            }

            function updateOutput() {
                const selectedContractType = getSelectedValue(contractTypeCheckboxes);
                const selectedTrafficManagement = getSelectedValue(trafficManagementCheckboxes);
                const isMoreThan12Hours = moreThan12HoursCheckbox.checked;
                const isEmergency = emergencyCheckbox.checked;

                let invoiceItems = [];
                let afpItems = [];
                let mainMessage = "Please make a selection from Contract Type and Traffic Management categories.";

                invoiceTableContainer.innerHTML = '';
                afpTableContainer.innerHTML = '';

                if (selectedContractType && selectedTrafficManagement) {
                    mainMessage = ""; // Reset, will be built.
                    let baseItemCodes = []; // Can now hold multiple codes, e.g., for "5 Way Lights"

                    if (selectedContractType === "OSA") {
                        // OSA Specific Logic
                        switch (selectedTrafficManagement) {
                            case "2 Way Lights (40mph>)": baseItemCodes.push("TM03"); break;
                            case "3 Way Lights": baseItemCodes.push("TM04"); break;
                            case "4 Way Lights": baseItemCodes.push("TM05"); break;
                            case "5 Way Lights": baseItemCodes.push("TM03", "TM04"); break; // Special case
                            case "Bus Stop Suspension": baseItemCodes.push("BUS_SUS"); break;
                            case "Footpath Closure": baseItemCodes.push("FOOT_CLOS"); break;
                            case "Lane Closure": baseItemCodes.push("TM08"); break;
                            case "Ped Crossing Only": baseItemCodes.push("TM10_PC"); break;
                            case "Pre Cone": baseItemCodes.push("PRE_CONE"); break;
                            case "Road closure": baseItemCodes.push("TM09"); break;
                            case "Road Closure NTR": baseItemCodes.push("TM22_RC_NTR"); break;
                            case "Stop and Go 2 Way": baseItemCodes.push("TM19"); break;
                            case "Stop and Go 3 Way": baseItemCodes.push("TM20"); break;
                            case "Stop and Go 4 Way": baseItemCodes.push("TM21"); break;
                            case "TM Plan only": baseItemCodes.push("TM16"); break;
                            case "TO15": baseItemCodes.push("TM13"); break;
                            case "TO15 NTR": baseItemCodes.push("TM22_TO15_NTR"); break;
                        }

                        baseItemCodes.forEach(code => {
                            const item = quoteItemsData[code];
                            if (item) {
                                if (item.onInvoice) invoiceItems.push(item);
                                if (item.onAfp) afpItems.push(item);
                                if (isMoreThan12Hours && item.has12hrVariant && quoteItemsData[item.has12hrVariant]) {
                                    const twelveHrItem = quoteItemsData[item.has12hrVariant];
                                    if (twelveHrItem.onInvoice) invoiceItems.push(twelveHrItem);
                                    if (twelveHrItem.onAfp) afpItems.push(twelveHrItem);
                                }
                            }
                        });

                        // OSA Additional Requirements
                        if (manualControlCheckbox.checked && quoteItemsData.TM11) {
                            if (quoteItemsData.TM11.onInvoice) invoiceItems.push(quoteItemsData.TM11);
                            if (quoteItemsData.TM11.onAfp) afpItems.push(quoteItemsData.TM11);
                        }
                        if (oohCheckbox.checked && quoteItemsData.TM14) {
                            if (quoteItemsData.TM14.onInvoice) invoiceItems.push(quoteItemsData.TM14);
                            // TM14 AFP status is false by default
                        }
                        if (pedSetsCheckbox.checked && quoteItemsData.TM10_PedSet) {
                            if (quoteItemsData.TM10_PedSet.onInvoice) invoiceItems.push(quoteItemsData.TM10_PedSet);
                            if (quoteItemsData.TM10_PedSet.onAfp) afpItems.push(quoteItemsData.TM10_PedSet);
                            if (isMoreThan12Hours && quoteItemsData.TM10_PedSet.has12hrVariant && quoteItemsData.TMA0_PedSet) {
                                if (quoteItemsData.TMA0_PedSet.onInvoice) invoiceItems.push(quoteItemsData.TMA0_PedSet);
                                if (quoteItemsData.TMA0_PedSet.onAfp) afpItems.push(quoteItemsData.TMA0_PedSet);
                            }
                        }

                    } else { // ONSA or Fibre Build - Use TBA placeholders
                        const itemKey = `${selectedContractType}_${selectedTrafficManagement.replace(/[^a-zA-Z0-9]/g, '')}_TBA`;
                        const itemKey12Hr = `${itemKey}_12HR`;

                        const tbaItem = {
                            code: "TBA",
                            description: `${selectedContractType} - ${selectedTrafficManagement} (Details TBA)`,
                            price: 0,
                            onInvoice: true, // Default for TBA
                            onAfp: true,     // Default for TBA
                            has12hrVariant: itemKey12Hr
                        };
                        const tbaItem12Hr = {
                            code: "TBA",
                            description: `${selectedContractType} - ${selectedTrafficManagement} additional 12 hours (Details TBA)`,
                            price: 0,
                            onInvoice: true,
                            onAfp: true
                        };
                        // Add to a temporary quoteItemsData to allow generic processing
                        // This is a bit of a hack; ideally, ONSA/Fibre would have their own full data structures.
                        quoteItemsData[itemKey] = tbaItem; 
                        quoteItemsData[itemKey12Hr] = tbaItem12Hr;

                        baseItemCodes.push(itemKey);

                        baseItemCodes.forEach(code => {
                            const item = quoteItemsData[code]; // Will pick up the dynamically added TBA item
                            if (item) {
                                if (item.onInvoice) invoiceItems.push(item);
                                if (item.onAfp) afpItems.push(item);
                                if (isMoreThan12Hours && item.has12hrVariant && quoteItemsData[item.has12hrVariant]) {
                                    const twelveHrItem = quoteItemsData[item.has12hrVariant];
                                    if (twelveHrItem.onInvoice) invoiceItems.push(twelveHrItem);
                                    if (twelveHrItem.onAfp) afpItems.push(twelveHrItem);
                                }
                            }
                        });
                        // Clean up temporary TBA items if necessary, or manage them if they persist
                        // delete quoteItemsData[itemKey]; 
                        // delete quoteItemsData[itemKey12Hr];
                        // For now, they persist for the session, which is fine.
                    }

                    // Handle Emergency Fee - always on AFP
                    if (isEmergency && quoteItemsData.TM15) {
                        if (!afpItems.find(item => item.code === "TM15")) {
                           afpItems.push(quoteItemsData.TM15);
                        }
                    }
                    
                    const anInvoiceIsNeeded = invoiceItems.length > 0;
                    const anAfpIsNeeded = afpItems.length > 0;

                    if (anInvoiceIsNeeded && anAfpIsNeeded) {
                        mainMessage = "You need to make an Invoice and an AFP.";
                    } else if (anInvoiceIsNeeded) {
                        mainMessage = "You need to make an Invoice.";
                    } else if (anAfpIsNeeded) {
                        mainMessage = "You need to make an AFP.";
                    } else {
                        mainMessage = "No specific quote actions identified for these selections.";
                    }
                    
                    if (anInvoiceIsNeeded) generateTable(invoiceTableContainer, "Invoice Items", invoiceItems);
                    if (anAfpIsNeeded) generateTable(afpTableContainer, "AFP Items", afpItems);

                }
                outputMessageElement.textContent = mainMessage;
            }
            updateOutput(); // Initial call
        });
    </script>
</body>
</html>
